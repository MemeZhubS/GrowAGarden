<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Empire - 2D Farming Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: 80px; /* Space for fixed header */
            padding-bottom: 80px; /* Space for bottom bar */
        }

        /* Fixed Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-bottom: 3px solid #2E8B57;
            z-index: 1000;
            height: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #2E8B57;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            font-size: 13px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #228B22, #32CD32);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4169E1, #6495ED);
        }

        .btn-secondary:hover {
            background: linear-gradient(45deg, #0000CD, #4169E1);
        }

        .btn-danger {
            background: linear-gradient(45deg, #DC143C, #FF6347);
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #B22222, #DC143C);
        }

        /* Main Game Area */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .garden-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 3px solid rgba(46, 139, 87, 0.2);
            margin-bottom: 20px;
        }

        .weather-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .garden-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 12px;
            max-width: 900px;
            margin: 0 auto;
            padding-top: 60px;
        }

        .plot {
            width: 80px;
            height: 80px;
            border: 3px dashed #8B4513;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background: linear-gradient(45deg, #DEB887, #D2B48C);
            transition: all 0.3s ease;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.15);
        }

        .plot:hover {
            border-color: #2E8B57;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
        }

        .plot.planted {
            border-style: solid;
            border-color: #228B22;
            background: linear-gradient(45deg, #90EE90, #98FB98);
        }

        .plant {
            font-size: 35px;
            transition: all 0.6s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            position: relative;
        }

        .growth-stage-0 { font-size: 18px; opacity: 0.6; }
        .growth-stage-1 { font-size: 28px; opacity: 0.8; }
        .growth-stage-2 { font-size: 38px; opacity: 1; }

        .plant.ready {
            animation: pulse 2s infinite;
        }

        /* Fixed Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            border-top: 3px solid #2E8B57;
            z-index: 1000;
            height: 80px;
            align-items: center;
        }

        .bottom-btn {
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
        }

        .bottom-btn:hover {
            background: linear-gradient(45deg, #228B22, #32CD32);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        }

        /* Popup Overlay */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .popup-overlay.active {
            display: flex;
        }

        .popup {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            position: relative;
            animation: popupSlideIn 0.3s ease;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .popup-header {
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
        }

        .popup-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .popup-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .popup-content {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 12px;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .shop-item {
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .shop-item:hover {
            border-color: #2E8B57;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.25);
        }

        .shop-item.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .shop-item-price {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .shop-item-stock {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Inventory Grid */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .inventory-item {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .inventory-item:hover {
            border-color: #2E8B57;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 139, 87, 0.25);
        }

        .inventory-item.selected {
            border-color: #FF6347;
            background: linear-gradient(45deg, #FFE4E1, #FFF0F5);
            transform: scale(1.05);
        }

        /* Achievement/Mission Items */
        .achievement-item, .mission-item {
            background: linear-gradient(45deg, #f9f9f9, #ffffff);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 4px solid #2E8B57;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .achievement-item:hover, .mission-item:hover {
            transform: translateX(5px);
        }

        .achievement-item.completed, .mission-item.completed {
            border-left-color: #FFD700;
            background: linear-gradient(45deg, #FFFACD, #FFF8DC);
        }

        /* Daily Login Calendar */
        .login-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .login-day {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-day.completed {
            border-color: #FFD700;
            background: linear-gradient(45deg, #FFFACD, #FFF8DC);
        }

        .login-day.current {
            border-color: #2E8B57;
            background: linear-gradient(45deg, #90EE90, #98FB98);
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 8px 0;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #2E8B57;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #2E8B57;
            font-size: 18px;
        }

        /* Player Status */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #2E8B57;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2500;
            font-weight: bold;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            font-size: 14px;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Auth Forms */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-label {
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        /* User Info Display */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(46, 139, 87, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(46, 139, 87, 0.2);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #2E8B57, #3CB371);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes harvest {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(1.3) rotate(-5deg); }
            75% { transform: scale(1.2) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .harvest-animation {
            animation: harvest 0.6s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                height: 70px;
            }

            body {
                padding-top: 70px;
                padding-bottom: 70px;
            }

            .title {
                font-size: 18px;
            }

            .garden-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .plot {
                width: 60px;
                height: 60px;
            }

            .bottom-bar {
                height: 70px;
                padding: 10px 15px;
            }

            .bottom-btn {
                padding: 10px 15px;
                font-size: 12px;
                min-width: 80px;
            }

            .popup {
                margin: 10px;
                max-height: 90vh;
            }

            .shop-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Online/Offline Status */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header">
        <div class="header-left">
            <div class="title">🌾 Garden Empire</div>
            <div class="currency-display">
                💰 <span id="heckless">1000</span> Heckless
            </div>
        </div>
        <div class="header-right">
            <div class="auth-buttons" id="authButtons">
                <button class="btn" onclick="openAuthPopup('login')">Login</button>
                <button class="btn btn-secondary" onclick="openAuthPopup('register')">Daftar</button>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="status-indicator" id="statusIndicator"></div>
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
            <button class="btn" onclick="openInventoryPopup()">🎒 Inventory</button>
            <button class="btn" onclick="openProgressPopup()">📊 Progress</button>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-container">
        <div class="garden-container">
            <div class="weather-display" id="weatherDisplay">☀️ Sunny</div>
            <div class="garden-grid" id="gardenGrid"></div>
        </div>

        <!-- Inventory Display -->
        <div class="garden-container">
            <h3 style="margin-bottom: 15px; color: #2E8B57;">🎒 Seed Inventory</h3>
            <div class="inventory-grid" id="inventoryGrid"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="clearSelection()">Clear Selection</button>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="bottom-bar">
        <button class="bottom-btn" onclick="openShopPopup('seed')">
            🌱 Seeds
        </button>
        <button class="bottom-btn" onclick="openShopPopup('gear')">
            ⚒️ Gear
        </button>
        <button class="bottom-btn" onclick="openShopPopup('pet')">
            🥚 Pets
        </button>
        <button class="bottom-btn" onclick="openSellPopup()">
            💰 Sell
        </button>
    </div>

    <!-- Popup Overlays -->
    
    <!-- Auth Popup -->
    <div class="popup-overlay" id="authPopup">
        <div class="popup">
            <div class="popup-header">
                <span id="authTitle">Login</span>
                <button class="popup-close" onclick="closePopup('authPopup')">&times;</button>
            </div>
            <div class="popup-content">
                <form class="auth-form" id="authForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="authEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="authPassword" required>
                    </div>
                    <button type="submit" class="btn" id="authSubmit">
                        <span id="authSubmitText">Login</span>
                        <div class="loading" id="authLoading" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Shop Popup -->
    <div class="popup-overlay" id="shopPopup">
        <div class="popup">
            <div class="popup-header">
                <span id="shopTitle">Shop</span>
                <button class="popup-close" onclick="closePopup('shopPopup')">&times;</button>
            </div>
            <div class="popup-content">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="background: linear-gradient(45deg, #FFD700, #FFA500); padding: 10px; border-radius: 10px; color: #8B4513; font-weight: bold;">
                        Next restock: <span id="shopTimer">7:00</span>
                    </div>
                </div>
                <div class="shop-grid" id="shopGrid"></div>
            </div>
        </div>
    </div>

    <!-- Inventory Popup -->
    <div class="popup-overlay" id="inventoryPopup">
        <div class="popup">
            <div class="popup-header">
                <span>🎒 Inventory</span>
                <button class="popup-close" onclick="closePopup('inventoryPopup')">&times;</button>
            </div>
            <div class="popup-content">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchInventoryTab('all')">All</button>
                    <button class="tab-btn" onclick="switchInventoryTab('seeds')">🌱 Seeds</button>
                    <button class="tab-btn" onclick="switchInventoryTab('tools')">⚒️ Tools</button>
                    <button class="tab-btn" onclick="switchInventoryTab('eggs')">🥚 Eggs</button>
                    <button class="tab-btn" onclick="switchInventoryTab('fruits')">🍎 Fruits</button>
                </div>
                <div class="inventory-grid" id="inventoryDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Sell Popup -->
    <div class="popup-overlay" id="sellPopup">
        <div class="popup">
            <div class="popup-header">
                <span>💰 Fruit Sell Stall</span>
                <button class="popup-close" onclick="closePopup('sellPopup')">&times;</button>
            </div>
            <div class="popup-content">
                <div id="sellFruitsList"></div>
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px;">
                    <div style="font-weight: bold; margin-bottom: 10px;">Selected Item:</div>
                    <div id="selectedFruitInfo">Select a fruit to sell</div>
                    <div style="margin-top: 15px; display: none;" id="sellControls">
                        <label>Quantity to sell:</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <button class="btn" onclick="adjustSellQuantity(-1)">-</button>
                            <input type="number" id="sellQuantity" value="1" min="1" style="width: 80px; text-align: center; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                            <button class="btn" onclick="adjustSellQuantity(1)">+</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Total Value: <span id="totalSellValue">0</span> 💰</strong>
                        </div>
                        <button class="btn" onclick="confirmSell()" style="margin-top: 15px; width: 100%;">Confirm Sale</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Popup -->
    <div class="popup-overlay" id="progressPopup">
        <div class="popup">
            <div class="popup-header">
                <span>📊 Progress</span>
                <button class="popup-close" onclick="closePopup('progressPopup')">&times;</button>
            </div>
            <div class="popup-content">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('achievements')">🏆 Achievements</button>
                    <button class="tab-btn" onclick="switchTab('missions')">🎯 Daily Missions</button>
                    <button class="tab-btn" onclick="switchTab('login')">🎁 Daily Login</button>
                    <button class="tab-btn" onclick="switchTab('leaderboard')" id="leaderboardTab">📊 Leaderboard</button>
                    <button class="tab-btn" onclick="switchTab('status')">👤 Status</button>
                </div>

                <!-- Achievements Tab -->
                <div class="tab-content active" id="achievementsTab">
                    <div id="achievementsList"></div>
                </div>

                <!-- Daily Missions Tab -->
                <div class="tab-content" id="missionsTab">
                    <div id="missionsList"></div>
                </div>

                <!-- Daily Login Tab -->
                <div class="tab-content" id="loginTab">
                    <h4 style="margin-bottom: 15px; text-align: center;">Daily Login Rewards</h4>
                    <div class="login-calendar" id="loginCalendar"></div>
                </div>

                <!-- Leaderboard Tab -->
                <div class="tab-content" id="leaderboardTab">
                    <div id="leaderboardList"></div>
                </div>

                <!-- Player Status Tab -->
                <div class="tab-content" id="statusTab">
                    <div class="status-grid" id="statusGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Configuration
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let user = null;
        let isOnline = false;

        // Initialize Firebase
        async function initFirebase() {
            try {
                // Replace with your Firebase config
                const firebaseConfig = {
                    apiKey: "your-api-key",
                    authDomain: "your-project.firebaseapp.com",
                    projectId: "your-project-id",
                    storageBucket: "your-project.appspot.com",
                    messagingSenderId: "123456789",
                    appId: "your-app-id"
                };

                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                // Listen for auth state changes
                onAuthStateChanged(auth, (firebaseUser) => {
                    if (firebaseUser) {
                        user = firebaseUser;
                        isOnline = true;
                        updateAuthUI();
                        loadCloudData();
                        showNotification('🌐 Connected to cloud!');
                    } else {
                        user = null;
                        isOnline = false;
                        updateAuthUI();
                        showNotification('📱 Playing offline');
                    }
                });

                console.log('Firebase initialized successfully');
            } catch (error) {
                console.log('Firebase not available:', error);
                isOnline = false;
                updateAuthUI();
            }
        }

        // Game Data Structure
        const gameData = {
            seeds: {
                carrot: { name: 'Carrot', icon: '🥕', rarity: 'Common', price: 20, growTime: 30000, harvestType: 'single', baseValue: 35, levelReq: 1 },
                strawberry: { name: 'Strawberry', icon: '🍓', rarity: 'Common', price: 25, growTime: 45000, harvestType: 'multi', baseValue: 40, durability: 5, levelReq: 1 },
                blueberry: { name: 'Blueberry', icon: '🫐', rarity: 'Common', price: 30, growTime: 40000, harvestType: 'multi', baseValue: 45, durability: 6, levelReq: 2 },
                orange_tulip: { name: 'Orange Tulip', icon: '🌷', rarity: 'Uncommon', price: 50, growTime: 60000, harvestType: 'single', baseValue: 80, levelReq: 3 },
                tomato: { name: 'Tomato', icon: '🍅', rarity: 'Uncommon', price: 45, growTime: 70000, harvestType: 'multi', baseValue: 65, durability: 4, levelReq: 3 },
                corn: { name: 'Corn', icon: '🌽', rarity: 'Uncommon', price: 55, growTime: 80000, harvestType: 'single', baseValue: 100, levelReq: 4 },
                daffodil: { name: 'Daffodil', icon: '🌼', rarity: 'Uncommon', price: 60, growTime: 75000, harvestType: 'single', baseValue: 95, levelReq: 4 },
                watermelon: { name: 'Watermelon', icon: '🍉', rarity: 'Rare', price: 100, growTime: 120000, harvestType: 'single', baseValue: 180, levelReq: 5 },
                pumpkin: { name: 'Pumpkin', icon: '🎃', rarity: 'Rare', price: 110, growTime: 140000, harvestType: 'single', baseValue: 220, levelReq: 6 },
                apple: { name: 'Apple', icon: '🍎', rarity: 'Rare', price: 120, growTime: 160000, harvestType: 'multi', baseValue: 150, durability: 8, levelReq: 6 },
                bamboo: { name: 'Bamboo', icon: '🎋', rarity: 'Rare', price: 130, growTime: 100000, harvestType: 'multi', baseValue: 110, durability: 12, levelReq: 7 },
                coconut: { name: 'Coconut', icon: '🥥', rarity: 'Epic', price: 180, growTime: 200000, harvestType: 'multi', baseValue: 250, durability: 6, levelReq: 8 },
                cactus: { name: 'Cactus', icon: '🌵', rarity: 'Epic', price: 200, growTime: 180000, harvestType: 'multi', baseValue: 200, durability: 15, levelReq: 8 },
                dragon_fruit: { name: 'Dragon Fruit', icon: '🐉', rarity: 'Epic', price: 250, growTime: 240000, harvestType: 'single', baseValue: 450, levelReq: 9 },
                mango: { name: 'Mango', icon: '🥭', rarity: 'Epic', price: 220, growTime: 220000, harvestType: 'multi', baseValue: 320, durability: 5, levelReq: 9 },
                grape: { name: 'Grape', icon: '🍇', rarity: 'Epic', price: 190, growTime: 190000, harvestType: 'multi', baseValue: 230, durability: 7, levelReq: 10 },
                mushroom: { name: 'Mushroom', icon: '🍄', rarity: 'Legendary', price: 350, growTime: 300000, harvestType: 'multi', baseValue: 500, durability: 10, levelReq: 12 },
                pepper: { name: 'Pepper', icon: '🌶️', rarity: 'Legendary', price: 320, growTime: 280000, harvestType: 'multi', baseValue: 450, durability: 8, levelReq: 12 },
                cacao: { name: 'Cacao', icon: '🍫', rarity: 'Legendary', price: 400, growTime: 320000, harvestType: 'multi', baseValue: 650, durability: 6, levelReq: 13 },
                beanstalk: { name: 'Beanstalk', icon: '🌱', rarity: 'Mythic', price: 600, growTime: 400000, harvestType: 'single', baseValue: 1000, levelReq: 15 },
                ember_lily: { name: 'Ember Lily', icon: '🔥', rarity: 'Mythic', price: 700, growTime: 450000, harvestType: 'multi', baseValue: 900, durability: 4, levelReq: 16 },
                sugar_apple: { name: 'Sugar Apple', icon: '🍏', rarity: 'Mythic', price: 650, growTime: 420000, harvestType: 'multi', baseValue: 800, durability: 5, levelReq: 16 },
                burning_bud: { name: 'Burning Bud', icon: '🌺', rarity: 'Mythic', price: 800, growTime: 480000, harvestType: 'single', baseValue: 1200, levelReq: 17 },
                giant_pinecone: { name: 'Giant Pinecone', icon: '🌲', rarity: 'Cosmic', price: 1200, growTime: 600000, harvestType: 'single', baseValue: 1800, levelReq: 20 },
                elder_strawberry: { name: 'Elder Strawberry', icon: '👑', rarity: 'Cosmic', price: 1400, growTime: 650000, harvestType: 'multi', baseValue: 1500, durability: 3, levelReq: 22 },
                romanesco: { name: 'Romanesco', icon: '🥦', rarity: 'Cosmic', price: 1800, growTime: 720000, harvestType: 'single', baseValue: 2500, levelReq: 25 }
            },
            gear: {
                small_sprinkler: { name: 'Small Sprinkler', icon: '💧', price: 250, duration: 600000, radius: 1, growthBonus: 0.2, sizeBonus: 0.15, mutationBonus: 0.1, levelReq: 3, type: 'sprinkler' },
                medium_sprinkler: { name: 'Medium Sprinkler', icon: '🌊', price: 600, duration: 900000, radius: 2, growthBonus: 0.35, sizeBonus: 0.25, mutationBonus: 0.18, levelReq: 6, type: 'sprinkler' },
                big_sprinkler: { name: 'Big Sprinkler', icon: '⛲', price: 1200, duration: 1200000, radius: 3, growthBonus: 0.5, sizeBonus: 0.4, mutationBonus: 0.25, levelReq: 10, type: 'sprinkler' },
                ultra_sprinkler: { name: 'Ultra Sprinkler', icon: '🌀', price: 2500, duration: 1800000, radius: 4, growthBonus: 0.8, sizeBonus: 0.6, mutationBonus: 0.4, levelReq: 15, type: 'sprinkler' },
                time_crystal_sprinkler: { name: 'Time Crystal Sprinkler', icon: '⏰', price: 8000, duration: 3600000, radius: 6, growthBonus: 1.2, sizeBonus: 1.0, mutationBonus: 0.8, levelReq: 25, type: 'sprinkler' },
                fertilizer_pack: { name: 'Fertilizer Pack', icon: '🌱', price: 150, effect: 'growth_boost', duration: 300000, bonus: 0.3, levelReq: 1, type: 'consumable' },
                basic_watering_can: { name: 'Basic Watering Can', icon: '🪣', price: 200, effect: 'yield_boost', duration: 600000, bonus: 0.25, levelReq: 2, type: 'consumable' },
                lucky_shovel: { name: 'Lucky Shovel', icon: '🪚', price: 500, effect: 'mutation_boost', duration: 900000, bonus: 0.4, levelReq: 5, type: 'consumable' },
                growth_lamp: { name: 'Growth Lamp', icon: '💡', price: 800, effect: 'growth_boost', duration: 1200000, bonus: 0.5, levelReq: 7, type: 'consumable' },
                auto_harvester: { name: 'Auto Harvester', icon: '🤖', price: 2000, effect: 'auto_harvest', duration: 1800000, bonus: 1.0, levelReq: 12, type: 'consumable' },
                golden_hoe: { name: 'Golden Hoe', icon: '⚱️', price: 3000, effect: 'all_boost', duration: 2400000, bonus: 0.6, levelReq: 15, type: 'consumable' },
                mutation_catalyst: { name: 'Mutation Catalyst', icon: '⚗️', price: 5000, effect: 'mutation_boost', duration: 3600000, bonus: 1.5, levelReq: 18, type: 'consumable' },
                rainbow_scarecrow: { name: 'Rainbow Scarecrow', icon: '🌈', price: 7500, effect: 'rainbow_boost', duration: 7200000, bonus: 2.0, levelReq: 20, type: 'consumable' },
                infinity_watering_orb: { name: 'Infinity Watering Orb', icon: '🔮', price: 15000, effect: 'all_boost', duration: 10800000, bonus: 1.8, levelReq: 30, type: 'consumable' }
            },
            petEggs: {
                cat_egg: { name: 'Cat Egg', icon: '🥚', price: 200, hatchTime: 300000, pets: ['cat'], levelReq: 2, rarity: 'Common' },
                dog_egg: { name: 'Dog Egg', icon: '🥚', price: 220, hatchTime: 320000, pets: ['dog'], levelReq: 2, rarity: 'Common' },
                bunny_egg: { name: 'Bunny Egg', icon: '🥚', price: 250, hatchTime: 350000, pets: ['rabbit'], levelReq: 3, rarity: 'Common' },
                fox_egg: { name: 'Fox Egg', icon: '🔸', price: 500, hatchTime: 600000, pets: ['fox'], levelReq: 5, rarity: 'Uncommon' },
                bird_egg: { name: 'Bird Egg', icon: '🔸', price: 480, hatchTime: 580000, pets: ['bird'], levelReq: 5, rarity: 'Uncommon' },
                turtle_egg: { name: 'Turtle Egg', icon: '🔸', price: 550, hatchTime: 650000, pets: ['turtle'], levelReq: 6, rarity: 'Uncommon' },
                dragon_egg: { name: 'Dragon Egg', icon: '🔮', price: 1200, hatchTime: 900000, pets: ['dragon'], levelReq: 10, rarity: 'Rare' },
                phoenix_egg: { name: 'Phoenix Egg', icon: '🔮', price: 1300, hatchTime: 950000, pets: ['phoenix'], levelReq: 11, rarity: 'Rare' },
                golem_egg: { name: 'Golem Egg', icon: '🔮', price: 1400, hatchTime: 1000000, pets: ['golem'], levelReq: 12, rarity: 'Rare' },
                unicorn_egg: { name: 'Unicorn Egg', icon: '💎', price: 2500, hatchTime: 1500000, pets: ['unicorn'], levelReq: 15, rarity: 'Epic' },
                spirit_wolf_egg: { name: 'Spirit Wolf Egg', icon: '💎', price: 2800, hatchTime: 1600000, pets: ['spirit_wolf'], levelReq: 16, rarity: 'Epic' },
                celestial_cat_egg: { name: 'Celestial Cat Egg', icon: '💎', price: 3000, hatchTime: 1700000, pets: ['celestial_cat'], levelReq: 17, rarity: 'Epic' },
                galaxy_dragon_egg: { name: 'Galaxy Dragon Egg', icon: '⭐', price: 5000, hatchTime: 2400000, pets: ['galaxy_dragon'], levelReq: 20, rarity: 'Legendary' },
                rainbow_phoenix_egg: { name: 'Rainbow Phoenix Egg', icon: '⭐', price: 5500, hatchTime: 2600000, pets: ['rainbow_phoenix'], levelReq: 22, rarity: 'Legendary' },
                void_serpent_egg: { name: 'Void Serpent Egg', icon: '⭐', price: 6000, hatchTime: 2800000, pets: ['void_serpent'], levelReq: 25, rarity: 'Legendary' }
            },
            pets: {
                dog: { name: 'Loyal Dog', icon: '🐕', buffs: { growthSpeed: 0.15, yieldBonus: 0.1, expBonus: 0.05 } },
                cat: { name: 'Lucky Cat', icon: '🐱', buffs: { mutationChance: 0.12, autoSell: 0.08, expBonus: 0.08 } },
                rabbit: { name: 'Speed Rabbit', icon: '🐰', buffs: { growthSpeed: 0.25, harvestSpeed: 0.15, expBonus: 0.1 } },
                fox: { name: 'Mystic Fox', icon: '🦊', buffs: { autoSell: 0.2, mutationChance: 0.18, expBonus: 0.18 } },
                bird: { name: 'Garden Bird', icon: '🐦', buffs: { yieldBonus: 0.2, mutationChance: 0.08, expBonus: 0.12 } },
                turtle: { name: 'Wise Turtle', icon: '🐢', buffs: { growthSpeed: 0.1, yieldBonus: 0.3, expBonus: 0.2 } },
                dragon: { name: 'Fire Dragon', icon: '🐲', buffs: { yieldBonus: 0.3, mutationChance: 0.2, expBonus: 0.15 } },
                phoenix: { name: 'Phoenix', icon: '🔥', buffs: { growthSpeed: 0.4, yieldBonus: 0.25, expBonus: 0.2 } },
                golem: { name: 'Stone Golem', icon: '🗿', buffs: { yieldBonus: 0.4, autoSell: 0.15, expBonus: 0.18 } },
                unicorn: { name: 'Unicorn', icon: '🦄', buffs: { mutationChance: 0.35, allBonus: 0.15, expBonus: 0.25 } },
                spirit_wolf: { name: 'Spirit Wolf', icon: '🐺', buffs: { growthSpeed: 0.5, mutationChance: 0.3, expBonus: 0.3 } },
                celestial_cat: { name: 'Celestial Cat', icon: '🌟', buffs: { allBonus: 0.25, autoSell: 0.3, expBonus: 0.35 } },
                galaxy_dragon: { name: 'Galaxy Dragon', icon: '🌌', buffs: { allBonus: 0.6, mutationChance: 0.8, expBonus: 0.8 } },
                rainbow_phoenix: { name: 'Rainbow Phoenix', icon: '🌈', buffs: { allBonus: 0.8, yieldBonus: 1.0, expBonus: 1.0 } },
                void_serpent: { name: 'Void Serpent', icon: '🐍', buffs: { mutationChance: 1.2, yieldBonus: 0.9, expBonus: 1.2 } }
            },
            weather: {
                sunny: { name: 'Sunny', icon: '☀️', growthMultiplier: 1.0, mutationMultiplier: 1.0, yieldMultiplier: 1.0, duration: 420000 },
                rainy: { name: 'Rainy', icon: '🌧️', growthMultiplier: 0.7, mutationMultiplier: 1.2, yieldMultiplier: 1.3, duration: 300000 },
                hot: { name: 'Hot', icon: '🔥', growthMultiplier: 1.3, mutationMultiplier: 0.8, yieldMultiplier: 0.8, duration: 360000 },
                stormy: { name: 'Stormy', icon: '⛈️', growthMultiplier: 1.1, mutationMultiplier: 2.0, yieldMultiplier: 1.4, harvestFailChance: 0.12, duration: 180000 },
                windy: { name: 'Windy', icon: '💨', growthMultiplier: 0.9, mutationMultiplier: 1.1, yieldMultiplier: 1.1, harvestFailChance: 0.06, duration: 240000 },
                foggy: { name: 'Foggy', icon: '🌫️', growthMultiplier: 0.8, mutationMultiplier: 1.6, yieldMultiplier: 0.95, duration: 210000 },
                rainbow: { name: 'Rainbow', icon: '🌈', growthMultiplier: 0.9, mutationMultiplier: 4.0, yieldMultiplier: 2.0, duration: 120000 }
            },
            sizes: {
                small: { name: 'Small', multiplier: 0.6, chance: 0.35 },
                normal: { name: 'Normal', multiplier: 1.0, chance: 0.35 },
                large: { name: 'Large', multiplier: 1.6, chance: 0.2 },
                super: { name: 'Super', multiplier: 2.5, chance: 0.1 }
            },
            mutations: {
                normal: { name: '', icon: '', multiplier: 1.0, chance: 0.65 },
                silver: { name: 'Silver', icon: '⭐', multiplier: 1.8, chance: 0.18 },
                gold: { name: 'Gold', icon: '✨', multiplier: 2.5, chance: 0.08 },
                diamond: { name: 'Diamond', icon: '💎', multiplier: 3.5, chance: 0.04 },
                rainbow: { name: 'Rainbow', icon: '🌈', multiplier: 5.0, chance: 0.02 },
                glitched: { name: 'Glitched', icon: '⚠️', multiplier: 7.0, chance: 0.01 },
                crystal: { name: 'Crystal', icon: '🔹', multiplier: 4.0, chance: 0.015 },
                shadow: { name: 'Shadow', icon: '🌑', multiplier: 6.0, chance: 0.005 },
                light: { name: 'Light', icon: '☀️', multiplier: 5.5, chance: 0.008 },
                toxic: { name: 'Toxic', icon: '☢️', multiplier: 8.0, chance: 0.003 },
                galaxy: { name: 'Galaxy', icon: '🌌', multiplier: 12.0, chance: 0.001 }
            }
        };

        // Shop Pools with Rarity-based Selection
        const shopPools = {
            seeds: {
                common: ['carrot', 'strawberry', 'blueberry', 'tomato', 'corn', 'daffodil', 'orange_tulip'],
                uncommon: ['watermelon', 'pumpkin', 'apple', 'bamboo', 'coconut', 'cactus'],
                rare: ['dragon_fruit', 'mango', 'grape', 'mushroom', 'pepper', 'cacao'],
                epic: ['beanstalk', 'ember_lily', 'sugar_apple'],
                legendary: ['burning_bud', 'giant_pinecone', 'elder_strawberry', 'romanesco']
            },
            gear: {
                common: ['small_sprinkler', 'fertilizer_pack', 'basic_watering_can'],
                uncommon: ['medium_sprinkler', 'lucky_shovel', 'growth_lamp'],
                rare: ['big_sprinkler', 'auto_harvester', 'golden_hoe'],
                epic: ['ultra_sprinkler', 'mutation_catalyst', 'rainbow_scarecrow'],
                legendary: ['time_crystal_sprinkler', 'infinity_watering_orb']
            },
            eggs: {
                common: ['cat_egg', 'dog_egg', 'bunny_egg'],
                uncommon: ['fox_egg', 'bird_egg', 'turtle_egg'],
                rare: ['dragon_egg', 'phoenix_egg', 'golem_egg'],
                epic: ['unicorn_egg', 'spirit_wolf_egg', 'celestial_cat_egg'],
                legendary: ['galaxy_dragon_egg', 'rainbow_phoenix_egg', 'void_serpent_egg']
            }
        };

        // Rarity chances for shop generation
        const rarityChances = {
            common: 0.50,
            uncommon: 0.25,
            rare: 0.15,
            epic: 0.07,
            legendary: 0.03
        };

        // Game State
        let gameState = {
            heckless: 1000,
            xp: 0,
            level: 1,
            plots: Array(50).fill(null).map((_, i) => ({ id: i, plant: null, sprinkler: null })),
            inventory: {
                seeds: { carrot: 3, strawberry: 2 },
                tools: {},
                eggs: {},
                fruits: {}
            },
            selectedSeed: null,
            currentWeather: 'sunny',
            weatherStartTime: Date.now(),
            shopStock: {
                seeds: [],
                gear: [],
                eggs: [],
                lastRestock: 0
            },
            missions: [],
            achievements: [],
            dailyLogin: {
                streak: 0,
                lastLogin: null,
                claimedToday: false,
                rewards: [
                    { day: 1, reward: { type: 'heckless', amount: 100 }, claimed: false },
                    { day: 2, reward: { type: 'seeds', items: { carrot: 2 } }, claimed: false },
                    { day: 3, reward: { type: 'heckless', amount: 200 }, claimed: false },
                    { day: 4, reward: { type: 'seeds', items: { strawberry: 3 } }, claimed: false },
                    { day: 5, reward: { type: 'heckless', amount: 300 }, claimed: false },
                    { day: 6, reward: { type: 'gear', items: { fertilizer_pack: 1 } }, claimed: false },
                    { day: 7, reward: { type: 'heckless', amount: 1000 }, claimed: false }
                ]
            },
            pet: { type: null, name: 'No Pet', level: 0, sprite: '🥚', buffs: {}, hasEgg: false, eggType: null, hatchTime: 0 },
            stats: {
                totalHarvested: 0,
                totalPlanted: 0,
                totalSold: 0,
                rareMutations: 0,
                totalEarned: 0
            },
            activeEffects: [],
            lastSave: Date.now()
        };

        // Utility Functions
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function getRandomFromWeighted(items, weightProperty = 'chance') {
            const totalWeight = Object.values(items).reduce((sum, item) => sum + item[weightProperty], 0);
            let random = Math.random() * totalWeight;
            
            for (const [key, item] of Object.entries(items)) {
                random -= item[weightProperty];
                if (random <= 0) return key;
            }
            return Object.keys(items)[0];
        }

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Authentication Functions
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const leaderboardTab = document.getElementById('leaderboardTab');

            if (user) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                statusIndicator.className = 'status-indicator status-online';
                userAvatar.textContent = user.email.charAt(0).toUpperCase();
                userName.textContent = user.email.split('@')[0];
                if (leaderboardTab) leaderboardTab.style.display = 'block';
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                statusIndicator.className = 'status-indicator status-offline';
                if (leaderboardTab) leaderboardTab.style.display = 'none';
            }
        }

        async function handleAuth(isLogin) {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const submitBtn = document.getElementById('authSubmit');
            const submitText = document.getElementById('authSubmitText');
            const loading = document.getElementById('authLoading');

            if (!email || !password) {
                showNotification('❌ Please fill in all fields');
                return;
            }

            submitBtn.disabled = true;
            submitText.style.display = 'none';
            loading.style.display = 'inline-block';

            try {
                if (isLogin) {
                    const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    await signInWithEmailAndPassword(auth, email, password);
                    showNotification('✅ Login successful!');
                } else {
                    const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    await createUserWithEmailAndPassword(auth, email, password);
                    showNotification('✅ Account created successfully!');
                }
                closePopup('authPopup');
            } catch (error) {
                showNotification(`❌ ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                loading.style.display = 'none';
            }
        }

        async function logout() {
            try {
                const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                await signOut(auth);
                showNotification('👋 Logged out successfully');
            } catch (error) {
                showNotification(`❌ ${error.message}`);
            }
        }

        // Cloud Data Functions
        async function saveCloudData() {
            if (!db || !user) return;

            try {
                const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const playerData = {
                    ...gameState,
                    lastSave: Date.now(),
                    userId: user.uid,
                    email: user.email
                };

                await setDoc(doc(db, 'players', user.uid), playerData);
                
                // Also save to leaderboard
                const leaderboardData = {
                    email: user.email.split('@')[0],
                    level: gameState.level,
                    heckless: gameState.heckless,
                    totalEarned: gameState.stats.totalEarned,
                    rareMutations: gameState.stats.rareMutations,
                    lastActive: Date.now()
                };
                
                await setDoc(doc(db, 'leaderboard', user.uid), leaderboardData);
                
            } catch (error) {
                console.log('Failed to save to cloud:', error);
            }
        }

        async function loadCloudData() {
            if (!db || !user) return;

            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const docRef = doc(db, 'players', user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    
                    // Only load if cloud save is newer
                    if (cloudData.lastSave > gameState.lastSave) {
                        gameState = { ...gameState, ...cloudData };
                        
                        // Reconstruct plant objects
                        gameState.plots.forEach(plot => {
                            if (plot.plant) {
                                const plant = new Plant(plot.plant.seedType, plot.plant.plotId);
                                Object.assign(plant, plot.plant);
                                plot.plant = plant;
                            }
                            if (plot.sprinkler) {
                                const sprinkler = new Sprinkler(plot.sprinkler.type, plot.sprinkler.plotId);
                                Object.assign(sprinkler, plot.sprinkler);
                                plot.sprinkler = sprinkler;
                            }
                        });
                        
                        showNotification('☁️ Cloud data loaded!');
                        updateDisplay();
                    }
                }
            } catch (error) {
                console.log('Failed to load from cloud:', error);
            }
        }

        // Fixed Shop System with Proper Timer
        function shouldRestockShop() {
            const now = Date.now();
            const timeSinceLastRestock = now - gameState.shopStock.lastRestock;
            return timeSinceLastRestock >= 420000; // 7 minutes in milliseconds
        }

        function generateShopStock() {
            if (!shouldRestockShop() && gameState.shopStock.seeds.length > 0) {
                return; // Don't restock if not time yet
            }

            const now = new Date();
            const seed = now.getTime(); // Use timestamp as seed for consistent generation
            
            // Generate seeds
            gameState.shopStock.seeds = generateShopItems('seeds', 8, seed);
            gameState.shopStock.gear = generateShopItems('gear', 6, seed + 1000);
            gameState.shopStock.eggs = generateShopItems('eggs', 5, seed + 2000);
            
            gameState.shopStock.lastRestock = Date.now();
            
            if (gameState.shopStock.seeds.length > 0) {
                showNotification('🛒 Shop restocked with new items!');
            }
        }

        function generateShopItems(poolType, count, seed) {
            const pool = shopPools[poolType];
            const items = [];
            
            // Use seeded random for consistent results
            let randomSeed = seed;
            function seededRandom() {
                randomSeed = (randomSeed * 9301 + 49297) % 233280;
                return randomSeed / 233280;
            }
            
            for (let i = 0; i < count; i++) {
                const rarityRoll = seededRandom();
                let selectedRarity = 'common';
                let cumulativeChance = 0;
                
                for (const [rarity, chance] of Object.entries(rarityChances)) {
                    cumulativeChance += chance;
                    if (rarityRoll <= cumulativeChance) {
                        selectedRarity = rarity;
                        break;
                    }
                }
                
                const rarityPool = pool[selectedRarity];
                if (rarityPool && rarityPool.length > 0) {
                    const index = Math.floor(seededRandom() * rarityPool.length);
                    const itemKey = rarityPool[index];
                    
                    let itemData;
                    if (poolType === 'seeds') itemData = gameData.seeds[itemKey];
                    else if (poolType === 'gear') itemData = gameData.gear[itemKey];
                    else if (poolType === 'eggs') itemData = gameData.petEggs[itemKey];
                    
                    if (itemData && gameState.level >= (itemData.levelReq || 1)) {
                        let stock = 1;
                        switch (selectedRarity) {
                            case 'common': stock = Math.floor(seededRandom() * 4) + 3; break;
                            case 'uncommon': stock = Math.floor(seededRandom() * 3) + 2; break;
                            case 'rare': stock = Math.floor(seededRandom() * 2) + 1; break;
                            case 'epic': stock = seededRandom() < 0.7 ? 1 : 0; break;
                            case 'legendary': stock = seededRandom() < 0.4 ? 1 : 0; break;
                        }
                        
                        items.push({ key: itemKey, stock, rarity: selectedRarity });
                    }
                }
            }
            
            return items;
        }

        function getNextRestockTime() {
            const timeSinceLastRestock = Date.now() - gameState.shopStock.lastRestock;
            return Math.max(0, 420000 - timeSinceLastRestock); // 7 minutes
        }

        // Plant Class
        class Plant {
            constructor(seedType, plotId) {
                this.seedType = seedType;
                this.plotId = plotId;
                this.plantedAt = Date.now();
                this.stage = 0;
                this.isReady = false;
                this.lastHarvest = 0;
                this.harvestCount = 0;
                this.durability = gameData.seeds[seedType].durability || 1;
                this.maxDurability = this.durability;
            }

            update() {
                const seed = gameData.seeds[this.seedType];
                const weather = gameData.weather[gameState.currentWeather];
                const elapsed = Date.now() - this.plantedAt - this.lastHarvest;
                
                let growTime = seed.growTime * weather.growthMultiplier;
                
                // Apply pet bonuses
                if (gameState.pet.buffs.growthSpeed) {
                    growTime *= (1 - gameState.pet.buffs.growthSpeed);
                }
                if (gameState.pet.buffs.allBonus) {
                    growTime *= (1 - gameState.pet.buffs.allBonus * 0.4);
                }

                // Apply sprinkler bonus
                const plot = gameState.plots[this.plotId];
                if (plot.sprinkler && plot.sprinkler.active) {
                    const sprinklerData = gameData.gear[plot.sprinkler.type];
                    growTime *= (1 - sprinklerData.growthBonus);
                }

                // Apply active consumable effects
                if (gameState.activeEffects) {
                    gameState.activeEffects.forEach(effect => {
                        if (effect.type === 'growth_boost' || effect.type === 'all_boost') {
                            growTime *= (1 - effect.bonus);
                        }
                    });
                }

                if (elapsed >= growTime && !this.isReady) {
                    this.isReady = true;
                    this.stage = 2;
                } else if (elapsed >= growTime * 0.66) {
                    this.stage = 2;
                } else if (elapsed >= growTime * 0.33) {
                    this.stage = 1;
                } else {
                    this.stage = 0;
                }
            }

            harvest() {
                if (!this.isReady) return null;

                const seed = gameData.seeds[this.seedType];
                const weather = gameData.weather[gameState.currentWeather];
                
                if (weather.harvestFailChance && Math.random() < weather.harvestFailChance) {
                    return { failed: true };
                }

                let sizeChances = { ...gameData.sizes };
                const plot = gameState.plots[this.plotId];
                if (plot.sprinkler && plot.sprinkler.active) {
                    const sprinklerData = gameData.gear[plot.sprinkler.type];
                    sizeChances.large.chance += sprinklerData.sizeBonus * 0.3;
                    sizeChances.super.chance += sprinklerData.sizeBonus * 0.2;
                }

                const sizeKey = getRandomFromWeighted(sizeChances);
                const size = gameData.sizes[sizeKey];

                let mutationChance = 0.35;
                mutationChance *= weather.mutationMultiplier;
                
                if (plot.sprinkler && plot.sprinkler.active) {
                    mutationChance += gameData.gear[plot.sprinkler.type].mutationBonus;
                }
                
                if (gameState.activeEffects) {
                    gameState.activeEffects.forEach(effect => {
                        if (effect.type === 'mutation_boost' || effect.type === 'all_boost') {
                            mutationChance += effect.bonus;
                        } else if (effect.type === 'rainbow_boost') {
                            if (gameState.currentWeather === 'rainbow') {
                                mutationChance += effect.bonus;
                            }
                        }
                    });
                }
                if (gameState.pet.buffs.mutationChance) {
                    mutationChance += gameState.pet.buffs.mutationChance;
                }
                if (gameState.pet.buffs.allBonus) {
                    mutationChance += gameState.pet.buffs.allBonus * 0.2;
                }

                const mutationKey = Math.random() < mutationChance ? 
                    getRandomFromWeighted(gameData.mutations) : 'normal';
                const mutation = gameData.mutations[mutationKey];

                let value = seed.baseValue * size.multiplier * mutation.multiplier * weather.yieldMultiplier;
                
                if (gameState.pet.buffs.yieldBonus) {
                    value *= (1 + gameState.pet.buffs.yieldBonus);
                }
                if (gameState.pet.buffs.allBonus) {
                    value *= (1 + gameState.pet.buffs.allBonus);
                }
                
                if (gameState.activeEffects) {
                    gameState.activeEffects.forEach(effect => {
                        if (effect.type === 'yield_boost' || effect.type === 'all_boost') {
                            value *= (1 + effect.bonus);
                        }
                    });
                }
                
                value = Math.floor(value);

                let xp = Math.floor(value / 8) + (mutationKey !== 'normal' ? 15 : 0);
                if (gameState.pet.buffs.expBonus) {
                    xp = Math.floor(xp * (1 + gameState.pet.buffs.expBonus));
                }

                const fruit = {
                    type: this.seedType,
                    size: sizeKey,
                    mutation: mutationKey,
                    value: value,
                    xp: xp,
                    icon: seed.icon + mutation.icon,
                    name: `${size.name} ${mutation.name} ${seed.name}`.trim().replace(/\s+/g, ' ')
                };

                if (mutationKey !== 'normal' && mutationKey !== 'silver') {
                    gameState.stats.rareMutations++;
                }

                const fruitKey = `${this.seedType}_${sizeKey}_${mutationKey}`;
                if (!gameState.inventory.fruits[fruitKey]) {
                    gameState.inventory.fruits[fruitKey] = {
                        name: fruit.name,
                        icon: fruit.icon,
                        value: fruit.value,
                        count: 0
                    };
                }
                gameState.inventory.fruits[fruitKey].count += 1;

                if (gameState.pet.buffs.autoSell && Math.random() < gameState.pet.buffs.autoSell) {
                    gameState.heckless += fruit.value;
                    gameState.xp += fruit.xp;
                    gameState.stats.totalSold += fruit.value;
                    gameState.stats.totalEarned += fruit.value;
                    showNotification(`${gameState.pet.name} auto-sold ${fruit.name} for ${fruit.value} 💰!`);
                    gameState.inventory.fruits[fruitKey].count -= 1;
                    if (gameState.inventory.fruits[fruitKey].count <= 0) {
                        delete gameState.inventory.fruits[fruitKey];
                    }
                }

                gameState.stats.totalHarvested++;

                if (seed.harvestType === 'single') {
                    return { fruit, remove: true };
                } else {
                    this.durability--;
                    if (this.durability <= 0) {
                        return { fruit, remove: true };
                    }
                    this.isReady = false;
                    this.lastHarvest = Date.now() - this.plantedAt;
                    this.harvestCount++;
                    this.stage = 0;
                    return { fruit, remove: false };
                }
            }
        }

        // Sprinkler Class
        class Sprinkler {
            constructor(type, plotId) {
                this.type = type;
                this.plotId = plotId;
                this.placedAt = Date.now();
                this.active = true;
            }

            update() {
                const sprinklerData = gameData.gear[this.type];
                const elapsed = Date.now() - this.placedAt;
                
                if (elapsed >= sprinklerData.duration) {
                    this.active = false;
                }
            }

            getTimeRemaining() {
                const sprinklerData = gameData.gear[this.type];
                const elapsed = Date.now() - this.placedAt;
                return Math.max(0, sprinklerData.duration - elapsed);
            }

            getProgress() {
                const sprinklerData = gameData.gear[this.type];
                const elapsed = Date.now() - this.placedAt;
                return Math.min(1, elapsed / sprinklerData.duration);
            }
        }

        // Save/Load Functions
        function saveGame() {
            gameState.lastSave = Date.now();
            localStorage.setItem('gardenEmpire', JSON.stringify(gameState));
            
            if (isOnline) {
                saveCloudData();
            }
        }

        function loadGame() {
            const saved = localStorage.getItem('gardenEmpire');
            if (saved) {
                const loadedState = JSON.parse(saved);
                gameState = { ...gameState, ...loadedState };
                
                gameState.plots.forEach(plot => {
                    if (plot.plant) {
                        const plant = new Plant(plot.plant.seedType, plot.plant.plotId);
                        Object.assign(plant, plot.plant);
                        plot.plant = plant;
                    }
                    if (plot.sprinkler) {
                        const sprinkler = new Sprinkler(plot.sprinkler.type, plot.sprinkler.plotId);
                        Object.assign(sprinkler, plot.sprinkler);
                        plot.sprinkler = sprinkler;
                    }
                });

                // Migrate old save data to new inventory system
                if (gameState.seedInventory && !gameState.inventory) {
                    gameState.inventory = {
                        seeds: gameState.seedInventory || {},
                        tools: {},
                        eggs: {},
                        fruits: gameState.harvestBasket || {}
                    };
                    
                    // Convert old harvest basket to new fruit format
                    const newFruits = {};
                    for (const [fruitKey, count] of Object.entries(gameState.harvestBasket || {})) {
                        const parts = fruitKey.split('_');
                        const seedType = parts[0];
                        const size = parts[1];
                        const mutation = parts[2];
                        
                        const seed = gameData.seeds[seedType];
                        const sizeData = gameData.sizes[size];
                        const mutationData = gameData.mutations[mutation];
                        
                        if (seed && sizeData && mutationData) {
                            const value = Math.floor(seed.baseValue * sizeData.multiplier * mutationData.multiplier);
                            const name = `${sizeData.name} ${mutationData.name} ${seed.name}`.trim().replace(/\s+/g, ' ');
                            const icon = seed.icon + mutationData.icon;
                            
                            newFruits[fruitKey] = {
                                name: name,
                                icon: icon,
                                value: value,
                                count: count
                            };
                        }
                    }
                    gameState.inventory.fruits = newFruits;
                }

                // Initialize missing properties
                if (!gameState.pet.buffs) gameState.pet.buffs = {};
                if (!gameState.stats) gameState.stats = { totalHarvested: 0, totalPlanted: 0, totalSold: 0, rareMutations: 0, totalEarned: 0 };
                if (!gameState.inventory) gameState.inventory = { seeds: {}, tools: {}, eggs: {}, fruits: {} };
                if (!gameState.shopStock) gameState.shopStock = { seeds: [], gear: [], eggs: [], lastRestock: 0 };
                if (!gameState.activeEffects) gameState.activeEffects = [];
                if (!gameState.dailyLogin) {
                    gameState.dailyLogin = {
                        streak: 0,
                        lastLogin: null,
                        claimedToday: false,
                        rewards: [
                            { day: 1, reward: { type: 'heckless', amount: 100 }, claimed: false },
                            { day: 2, reward: { type: 'seeds', items: { carrot: 2 } }, claimed: false },
                            { day: 3, reward: { type: 'heckless', amount: 200 }, claimed: false },
                            { day: 4, reward: { type: 'seeds', items: { strawberry: 3 } }, claimed: false },
                            { day: 5, reward: { type: 'heckless', amount: 300 }, claimed: false },
                            { day: 6, reward: { type: 'gear', items: { fertilizer_pack: 1 } }, claimed: false },
                            { day: 7, reward: { type: 'heckless', amount: 1000 }, claimed: false }
                        ]
                    };
                }
                if (gameState.dailyLogin.claimedToday === undefined) {
                    gameState.dailyLogin.claimedToday = false;
                }
            }
            initializeMissions();
            initializeAchievements();
            checkDailyLogin();
            generateShopStock(); // Initialize shop stock
        }

        // Fixed Daily Login System
        function checkDailyLogin() {
            const now = new Date();
            const today = now.toDateString();
            
            if (!gameState.dailyLogin.lastLogin || gameState.dailyLogin.lastLogin !== today) {
                const lastLoginDate = gameState.dailyLogin.lastLogin ? new Date(gameState.dailyLogin.lastLogin) : null;
                const daysDiff = lastLoginDate ? Math.floor((now - lastLoginDate) / (1000 * 60 * 60 * 24)) : 1;
                
                if (daysDiff === 1) {
                    // Consecutive day
                    gameState.dailyLogin.streak = Math.min(gameState.dailyLogin.streak + 1, 7);
                } else if (daysDiff > 1) {
                    // Streak broken
                    gameState.dailyLogin.streak = 1;
                    // Reset all rewards
                    gameState.dailyLogin.rewards.forEach(reward => reward.claimed = false);
                }
                
                gameState.dailyLogin.lastLogin = today;
                gameState.dailyLogin.claimedToday = false; // Reset daily claim status
                
                // Show daily login notification
                if (gameState.dailyLogin.streak > 0) {
                    showNotification(`🎁 Day ${gameState.dailyLogin.streak} login reward available!`);
                }
                
                saveGame();
            }
        }

        function claimDailyReward(day) {
            const reward = gameState.dailyLogin.rewards.find(r => r.day === day);
            if (!reward || reward.claimed || day > gameState.dailyLogin.streak || gameState.dailyLogin.claimedToday) return;
            
            reward.claimed = true;
            gameState.dailyLogin.claimedToday = true;
            
            switch (reward.reward.type) {
                case 'heckless':
                    gameState.heckless += reward.reward.amount;
                    showNotification(`🎁 Claimed ${reward.reward.amount} Heckless!`);
                    break;
                case 'seeds':
                    for (const [seed, amount] of Object.entries(reward.reward.items)) {
                        gameState.inventory.seeds[seed] = (gameState.inventory.seeds[seed] || 0) + amount;
                    }
                    showNotification(`🎁 Claimed seeds!`);
                    break;
                case 'gear':
                    for (const [gear, amount] of Object.entries(reward.reward.items)) {
                        gameState.inventory.tools[gear] = (gameState.inventory.tools[gear] || 0) + amount;
                    }
                    showNotification(`🎁 Claimed gear items!`);
                    break;
            }
            
            updateDisplay();
            saveGame();
        }

        // Level Up Rewards
        function giveRandomReward() {
            const rewardTypes = ['seeds', 'heckless', 'gear'];
            const rewardType = rewardTypes[Math.floor(Math.random() * rewardTypes.length)];
            
            switch (rewardType) {
                case 'seeds':
                    const availableSeeds = Object.keys(gameData.seeds).filter(key => 
                        gameState.level >= (gameData.seeds[key].levelReq || 1)
                    );
                    const randomSeed = availableSeeds[Math.floor(Math.random() * availableSeeds.length)];
                    const amount = Math.floor(Math.random() * 3) + 1;
                    gameState.inventory.seeds[randomSeed] = (gameState.inventory.seeds[randomSeed] || 0) + amount;
                    showNotification(`🎁 Level up reward: ${amount}x ${gameData.seeds[randomSeed].name} seeds!`);
                    break;
                case 'heckless':
                    const hecklassReward = gameState.level * 100;
                    gameState.heckless += hecklassReward;
                    showNotification(`🎁 Level up reward: ${hecklassReward} Heckless!`);
                    break;
                case 'gear':
                    if (gameState.level >= 3) {
                        const availableGear = Object.keys(gameData.gear).filter(key => 
                            gameState.level >= (gameData.gear[key].levelReq || 1) && 
                            gameData.gear[key].type === 'consumable'
                        );
                        if (availableGear.length > 0) {
                            const randomGear = availableGear[Math.floor(Math.random() * availableGear.length)];
                            gameState.inventory.tools[randomGear] = (gameState.inventory.tools[randomGear] || 0) + 1;
                            showNotification(`🎁 Level up reward: ${gameData.gear[randomGear].name} added to inventory!`);
                        }
                    }
                    break;
            }
        }

        // Game Functions
        function updateDisplay() {
            document.getElementById('heckless').textContent = gameState.heckless;

            const weather = gameData.weather[gameState.currentWeather];
            document.getElementById('weatherDisplay').textContent = `${weather.icon} ${weather.name}`;

            updateGarden();
            updateInventory();
            updateShopTimer();
        }

        function updateGarden() {
            const grid = document.getElementById('gardenGrid');
            grid.innerHTML = '';

            gameState.plots.forEach((plot, index) => {
                const plotElement = document.createElement('div');
                plotElement.className = 'plot';
                
                if (plot.plant) {
                    plotElement.classList.add('planted');
                    plot.plant.update();
                    
                    const plantElement = document.createElement('div');
                    plantElement.className = `plant growth-stage-${plot.plant.stage}`;
                    plantElement.textContent = gameData.seeds[plot.plant.seedType].icon;
                    
                    if (plot.plant.isReady) {
                        plantElement.classList.add('ready');
                    }
                    
                    plotElement.appendChild(plantElement);
                }

                if (plot.sprinkler) {
                    plot.sprinkler.update();
                    
                    const sprinklerElement = document.createElement('div');
                    sprinklerElement.style.position = 'absolute';
                    sprinklerElement.style.top = '-8px';
                    sprinklerElement.style.right = '-8px';
                    sprinklerElement.style.fontSize = '16px';
                    sprinklerElement.style.background = plot.sprinkler.active ? 
                        'linear-gradient(45deg, #87CEEB, #00BFFF)' : '#ccc';
                    sprinklerElement.style.borderRadius = '50%';
                    sprinklerElement.style.width = '28px';
                    sprinklerElement.style.height = '28px';
                    sprinklerElement.style.display = 'flex';
                    sprinklerElement.style.alignItems = 'center';
                    sprinklerElement.style.justifyContent = 'center';
                    sprinklerElement.style.border = '2px solid white';
                    sprinklerElement.textContent = gameData.gear[plot.sprinkler.type].icon;
                    
                    plotElement.appendChild(sprinklerElement);
                }

                plotElement.addEventListener('click', () => handlePlotClick(index));
                grid.appendChild(plotElement);
            });
        }

        function handlePlotClick(plotIndex) {
            const plot = gameState.plots[plotIndex];

            if (plot.plant && plot.plant.isReady) {
                const result = plot.plant.harvest();
                if (result.failed) {
                    showNotification('❌ Harvest failed due to weather!');
                    return;
                }

                const plotElement = document.querySelectorAll('.plot')[plotIndex];
                plotElement.classList.add('harvest-animation');
                setTimeout(() => plotElement.classList.remove('harvest-animation'), 600);

                if (result.fruit.mutation !== 'normal') {
                    showNotification(`✨ Harvested ${result.fruit.name}! (+${result.fruit.xp} XP)`);
                }

                gameState.xp += result.fruit.xp;
                checkLevelUp();

                if (result.remove) {
                    plot.plant = null;
                }

                updateDisplay();
                saveGame();
                return;
            }

            if (!plot.plant && gameState.selectedSeed) {
                const seed = gameData.seeds[gameState.selectedSeed];
                if (gameState.inventory.seeds[gameState.selectedSeed] > 0) {
                    gameState.inventory.seeds[gameState.selectedSeed]--;
                    if (gameState.inventory.seeds[gameState.selectedSeed] <= 0) {
                        delete gameState.inventory.seeds[gameState.selectedSeed];
                    }
                    plot.plant = new Plant(gameState.selectedSeed, plotIndex);
                    gameState.stats.totalPlanted++;
                    showNotification(`🌱 Planted ${seed.name}!`);
                    updateDisplay();
                    saveGame();
                }
                return;
            }
        }

        function updateInventory() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';

            for (const [seedKey, seed] of Object.entries(gameData.seeds)) {
                const count = gameState.inventory.seeds[seedKey] || 0;
                if (count > 0 || gameState.level >= (seed.levelReq || 1)) {
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = `inventory-item ${count === 0 ? 'empty' : ''}`;
                    
                    if (gameState.selectedSeed === seedKey) {
                        inventoryItem.classList.add('selected');
                    }
                    
                    let rarityColor = '';
                    switch (seed.rarity) {
                        case 'Uncommon': rarityColor = 'color: #228B22;'; break;
                        case 'Rare': rarityColor = 'color: #4169E1;'; break;
                        case 'Epic': rarityColor = 'color: #9932CC;'; break;
                        case 'Legendary': rarityColor = 'color: #FF8C00;'; break;
                        case 'Mythic': rarityColor = 'color: #DC143C;'; break;
                        case 'Cosmic': rarityColor = 'color: #FFD700;'; break;
                    }
                    
                    inventoryItem.innerHTML = `
                        <div style="font-size: 28px; margin-bottom: 8px;">${seed.icon}</div>
                        <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px; ${rarityColor}">${seed.name}</div>
                        <div style="font-size: 12px; color: #666;">×${count}</div>
                    `;
                    
                    if (count > 0) {
                        inventoryItem.addEventListener('click', () => selectSeed(seedKey));
                    }
                    
                    inventoryGrid.appendChild(inventoryItem);
                }
            }
        }

        function selectSeed(seedKey) {
            document.querySelectorAll('.inventory-item.selected').forEach(item => item.classList.remove('selected'));
            
            gameState.selectedSeed = seedKey;
            
            event.target.closest('.inventory-item').classList.add('selected');
            showNotification(`Selected ${gameData.seeds[seedKey].name} for planting!`);
        }

        function clearSelection() {
            gameState.selectedSeed = null;
            document.querySelectorAll('.inventory-item.selected').forEach(item => item.classList.remove('selected'));
            showNotification('Selection cleared!');
        }

        function checkLevelUp() {
            const xpNeeded = gameState.level * 100;
            if (gameState.xp >= xpNeeded) {
                gameState.level++;
                gameState.xp -= xpNeeded;
                showNotification(`🎉 Level up! You are now level ${gameState.level}!`);
                
                giveRandomReward();
                updateDisplay();
                saveGame();
            }
        }

        function updateWeather() {
            const weatherKeys = Object.keys(gameData.weather);
            const currentWeather = gameData.weather[gameState.currentWeather];
            const elapsed = Date.now() - gameState.weatherStartTime;
            
            if (elapsed >= currentWeather.duration) {
                const newWeather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];
                gameState.currentWeather = newWeather;
                gameState.weatherStartTime = Date.now();
                const weather = gameData.weather[newWeather];
                showNotification(`🌤️ Weather changed to ${weather.name}!`);
                updateDisplay();
            }
        }

        function updateShopTimer() {
            const remaining = getNextRestockTime();
            const timeStr = formatTime(remaining);
            const timerElement = document.getElementById('shopTimer');
            if (timerElement) {
                timerElement.textContent = timeStr;
            }
        }

        function initializeMissions() {
            if (gameState.missions.length === 0) {
                const today = new Date().toDateString();
                gameState.missions = [
                    { id: 1, description: 'Plant 10 seeds', type: 'plant', target: 10, current: 0, reward: 200, completed: false, date: today },
                    { id: 2, description: 'Harvest 15 fruits', type: 'harvest', target: 15, current: 0, reward: 300, completed: false, date: today },
                    { id: 3, description: 'Earn 500 Heckless', type: 'earn', target: 500, current: 0, reward: 400, completed: false, date: today },
                    { id: 4, description: 'Get 3 rare mutations', type: 'mutation', target: 3, current: 0, reward: 600, completed: false, date: today }
                ];
            }
            
            // Reset daily missions if it's a new day
            const today = new Date().toDateString();
            if (gameState.missions.length > 0 && gameState.missions[0].date !== today) {
                gameState.missions = [
                    { id: 1, description: 'Plant 10 seeds', type: 'plant', target: 10, current: 0, reward: 200, completed: false, date: today },
                    { id: 2, description: 'Harvest 15 fruits', type: 'harvest', target: 15, current: 0, reward: 300, completed: false, date: today },
                    { id: 3, description: 'Earn 500 Heckless', type: 'earn', target: 500, current: 0, reward: 400, completed: false, date: today },
                    { id: 4, description: 'Get 3 rare mutations', type: 'mutation', target: 3, current: 0, reward: 600, completed: false, date: today }
                ];
            }
        }

        function initializeAchievements() {
            if (gameState.achievements.length === 0) {
                gameState.achievements = [
                    { id: 1, name: 'Green Thumb', description: 'Plant 100 seeds', target: 100, current: 0, reward: 1500, completed: false },
                    { id: 2, name: 'Master Harvester', description: 'Harvest 500 fruits', target: 500, current: 0, reward: 3000, completed: false },
                    { id: 3, name: 'Mutation Hunter', description: 'Get 50 rare mutations', target: 50, current: 0, reward: 4000, completed: false },
                    { id: 4, name: 'Wealthy Gardener', description: 'Earn 25,000 Heckless', target: 25000, current: 0, reward: 8000, completed: false },
                    { id: 5, name: 'Level Master', description: 'Reach level 25', target: 25, current: 0, reward: 15000, completed: false }
                ];
            }
        }

        function applyConsumableEffect(gear) {
            if (!gameState.activeEffects) gameState.activeEffects = [];
            
            const effect = {
                type: gear.effect,
                bonus: gear.bonus,
                startTime: Date.now(),
                duration: gear.duration,
                name: gear.name
            };
            
            gameState.activeEffects.push(effect);
            
            gameState.activeEffects = gameState.activeEffects.filter(e => 
                Date.now() - e.startTime < e.duration
            );
        }

        // UI Functions
        function openAuthPopup(type) {
            const popup = document.getElementById('authPopup');
            const title = document.getElementById('authTitle');
            const submitText = document.getElementById('authSubmitText');
            const form = document.getElementById('authForm');
            
            title.textContent = type === 'login' ? 'Login' : 'Daftar';
            submitText.textContent = type === 'login' ? 'Login' : 'Daftar';
            
            form.onsubmit = (e) => {
                e.preventDefault();
                handleAuth(type === 'login');
            };
            
            popup.classList.add('active');
        }

        function openShopPopup(shopType) {
            // Generate shop stock if needed
            generateShopStock();
            
            const popup = document.getElementById('shopPopup');
            const title = document.getElementById('shopTitle');
            const grid = document.getElementById('shopGrid');
            
            let shopTitle = '';
            let items = [];
            
            switch (shopType) {
                case 'seed':
                    shopTitle = '🌱 Seed Shop';
                    items = gameState.shopStock.seeds;
                    break;
                case 'gear':
                    shopTitle = '⚒️ Gear Shop';
                    items = gameState.shopStock.gear;
                    break;
                case 'pet':
                    shopTitle = '🥚 Pet Shop';
                    items = gameState.shopStock.eggs;
                    break;
            }
            
            title.textContent = shopTitle;
            grid.innerHTML = '';
            
            for (const { key, stock, rarity } of items) {
                let itemData;
                if (shopType === 'seed') itemData = gameData.seeds[key];
                else if (shopType === 'gear') itemData = gameData.gear[key];
                else if (shopType === 'pet') itemData = gameData.petEggs[key];
                
                const shopItem = document.createElement('div');
                shopItem.className = `shop-item ${stock === 0 ? 'out-of-stock' : ''}`;
                
                let rarityColor = '';
                switch (rarity || itemData.rarity) {
                    case 'uncommon':
                    case 'Uncommon': rarityColor = 'color: #228B22;'; break;
                    case 'rare':
                    case 'Rare': rarityColor = 'color: #4169E1;'; break;
                    case 'epic':
                    case 'Epic': rarityColor = 'color: #9932CC;'; break;
                    case 'legendary':
                    case 'Legendary': rarityColor = 'color: #FFD700;'; break;
                    case 'Mythic': rarityColor = 'color: #DC143C;'; break;
                    case 'Cosmic': rarityColor = 'color: #FFD700;'; break;
                }
                
                shopItem.innerHTML = `
                    <div class="shop-item-icon">${itemData.icon}</div>
                    <div class="shop-item-name" style="${rarityColor}">${itemData.name}</div>
                    <div class="shop-item-price">${itemData.price}💰</div>
                    <div class="shop-item-stock" style="background: ${stock === 0 ? '#ff4444' : stock <= 1 ? '#ff8800' : '#44aa44'}">${stock === 0 ? 'OUT' : stock}</div>
                `;
                
                if (stock > 0) {
                    shopItem.addEventListener('click', () => buyItem(shopType, key));
                }
                
                grid.appendChild(shopItem);
            }
            
            popup.classList.add('active');
        }

        function openInventoryPopup() {
            const popup = document.getElementById('inventoryPopup');
            popup.classList.add('active');
            switchInventoryTab('all');
        }

        function switchInventoryTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#inventoryPopup .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            updateInventoryDisplay(tabName);
        }

        function updateInventoryDisplay(category = 'all') {
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            inventoryDisplay.innerHTML = '';

            if (category === 'all' || category === 'seeds') {
                for (const [seedKey, count] of Object.entries(gameState.inventory.seeds)) {
                    if (count > 0) {
                        const seed = gameData.seeds[seedKey];
                        const item = createInventoryItem(seed.icon, seed.name, count, seed.rarity, () => selectSeed(seedKey));
                        inventoryDisplay.appendChild(item);
                    }
                }
            }

            if (category === 'all' || category === 'tools') {
                for (const [toolKey, count] of Object.entries(gameState.inventory.tools)) {
                    if (count > 0) {
                        const tool = gameData.gear[toolKey];
                        const item = createInventoryItem(tool.icon, tool.name, count, tool.rarity || 'Common', () => useTool(toolKey));
                        inventoryDisplay.appendChild(item);
                    }
                }
            }

            if (category === 'all' || category === 'eggs') {
                for (const [eggKey, count] of Object.entries(gameState.inventory.eggs)) {
                    if (count > 0) {
                        const egg = gameData.petEggs[eggKey];
                        const item = createInventoryItem(egg.icon, egg.name, count, egg.rarity, () => useEgg(eggKey));
                        inventoryDisplay.appendChild(item);
                    }
                }
            }

            if (category === 'all' || category === 'fruits') {
                for (const [fruitKey, fruitData] of Object.entries(gameState.inventory.fruits)) {
                    if (fruitData.count > 0) {
                        const item = createInventoryItem(fruitData.icon, fruitData.name, fruitData.count, 'Fruit', () => selectFruitForSale(fruitKey));
                        inventoryDisplay.appendChild(item);
                    }
                }
            }

            if (inventoryDisplay.children.length === 0) {
                inventoryDisplay.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No items in this category</div>';
            }
        }

        function createInventoryItem(icon, name, count, rarity, onClick) {
            const item = document.createElement('div');
            item.className = 'inventory-item';
            
            let rarityColor = '';
            switch (rarity) {
                case 'Uncommon': rarityColor = 'color: #228B22;'; break;
                case 'Rare': rarityColor = 'color: #4169E1;'; break;
                case 'Epic': rarityColor = 'color: #9932CC;'; break;
                case 'Legendary': rarityColor = 'color: #FF8C00;'; break;
                case 'Mythic': rarityColor = 'color: #DC143C;'; break;
                case 'Cosmic': rarityColor = 'color: #FFD700;'; break;
                case 'Fruit': rarityColor = 'color: #FF6347;'; break;
            }
            
            item.innerHTML = `
                <div style="font-size: 28px; margin-bottom: 8px;">${icon}</div>
                <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px; ${rarityColor}">${name}</div>
                <div style="font-size: 12px; color: #666;">×${count}</div>
            `;
            
            item.addEventListener('click', onClick);
            return item;
        }

        function openSellPopup() {
            const popup = document.getElementById('sellPopup');
            popup.classList.add('active');
            updateSellFruitsList();
        }

        let selectedFruitForSale = null;

        function updateSellFruitsList() {
            const fruitsList = document.getElementById('sellFruitsList');
            fruitsList.innerHTML = '';

            const fruits = Object.entries(gameState.inventory.fruits).filter(([key, data]) => data.count > 0);
            
            if (fruits.length === 0) {
                fruitsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No fruits to sell</div>';
                return;
            }

            fruits.forEach(([fruitKey, fruitData]) => {
                const fruitItem = document.createElement('div');
                fruitItem.className = 'inventory-item';
                fruitItem.innerHTML = `
                    <div style="font-size: 28px; margin-bottom: 8px;">${fruitData.icon}</div>
                    <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #FF6347;">${fruitData.name}</div>
                    <div style="font-size: 12px; color: #666;">×${fruitData.count}</div>
                    <div style="font-size: 10px; color: #4CAF50;">${fruitData.value}💰 each</div>
                `;
                
                fruitItem.addEventListener('click', () => selectFruitForSale(fruitKey));
                fruitsList.appendChild(fruitItem);
            });
        }

        function selectFruitForSale(fruitKey) {
            selectedFruitForSale = fruitKey;
            const fruitData = gameState.inventory.fruits[fruitKey];
            
            document.getElementById('selectedFruitInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${fruitData.icon}</span>
                    <div>
                        <div style="font-weight: bold;">${fruitData.name}</div>
                        <div style="color: #4CAF50;">${fruitData.value}💰 each</div>
                        <div style="color: #666;">Available: ${fruitData.count}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('sellControls').style.display = 'block';
            document.getElementById('sellQuantity').max = fruitData.count;
            document.getElementById('sellQuantity').value = 1;
            updateSellValue();
        }

        function adjustSellQuantity(change) {
            const input = document.getElementById('sellQuantity');
            const newValue = Math.max(1, Math.min(parseInt(input.max), parseInt(input.value) + change));
            input.value = newValue;
            updateSellValue();
        }

        function updateSellValue() {
            if (!selectedFruitForSale) return;
            
            const quantity = parseInt(document.getElementById('sellQuantity').value);
            const fruitData = gameState.inventory.fruits[selectedFruitForSale];
            const totalValue = quantity * fruitData.value;
            
            document.getElementById('totalSellValue').textContent = totalValue;
        }

        function confirmSell() {
            if (!selectedFruitForSale) return;
            
            const quantity = parseInt(document.getElementById('sellQuantity').value);
            const fruitData = gameState.inventory.fruits[selectedFruitForSale];
            const totalValue = quantity * fruitData.value;
            
            gameState.heckless += totalValue;
            gameState.stats.totalSold += totalValue;
            gameState.stats.totalEarned += totalValue;
            
            fruitData.count -= quantity;
            if (fruitData.count <= 0) {
                delete gameState.inventory.fruits[selectedFruitForSale];
            }
            
            showNotification(`💰 Sold ${quantity}x ${fruitData.name} for ${totalValue} Heckless!`);
            
            selectedFruitForSale = null;
            document.getElementById('sellControls').style.display = 'none';
            document.getElementById('selectedFruitInfo').textContent = 'Select a fruit to sell';
            
            updateSellFruitsList();
            updateDisplay();
            saveGame();
        }

        function buyItem(shopType, itemKey) {
            let itemData, price, shopStock;
            
            switch (shopType) {
                case 'seed':
                    itemData = gameData.seeds[itemKey];
                    price = itemData.price;
                    shopStock = gameState.shopStock.seeds;
                    break;
                case 'gear':
                    itemData = gameData.gear[itemKey];
                    price = itemData.price;
                    shopStock = gameState.shopStock.gear;
                    break;
                case 'pet':
                    itemData = gameData.petEggs[itemKey];
                    price = itemData.price;
                    shopStock = gameState.shopStock.eggs;
                    break;
            }
            
            // Find the item in shop stock
            const stockItem = shopStock.find(item => item.key === itemKey);
            if (!stockItem || stockItem.stock <= 0) {
                showNotification('❌ Item out of stock!');
                return;
            }
            
            if (gameState.heckless < price) {
                showNotification(`❌ Not enough Heckless! Need ${price - gameState.heckless} more.`);
                return;
            }
            
            gameState.heckless -= price;
            stockItem.stock -= 1; // Reduce stock
            
            switch (shopType) {
                case 'seed':
                    gameState.inventory.seeds[itemKey] = (gameState.inventory.seeds[itemKey] || 0) + 1;
                    showNotification(`✅ Bought ${itemData.name} seed!`);
                    break;
                case 'gear':
                    if (itemData.type === 'sprinkler') {
                        const emptyPlot = gameState.plots.find(plot => !plot.sprinkler);
                        if (emptyPlot) {
                            emptyPlot.sprinkler = new Sprinkler(itemKey, emptyPlot.id);
                            showNotification(`✅ Placed ${itemData.name}!`);
                        } else {
                            gameState.inventory.tools[itemKey] = (gameState.inventory.tools[itemKey] || 0) + 1;
                            showNotification(`✅ Bought ${itemData.name}! Added to inventory.`);
                        }
                    } else if (itemData.type === 'consumable') {
                        gameState.inventory.tools[itemKey] = (gameState.inventory.tools[itemKey] || 0) + 1;
                        showNotification(`✅ Bought ${itemData.name}! Added to inventory.`);
                    }
                    break;
                case 'pet':
                    if (gameState.pet.hasEgg || gameState.pet.type) {
                        gameState.inventory.eggs[itemKey] = (gameState.inventory.eggs[itemKey] || 0) + 1;
                        showNotification(`✅ Bought ${itemData.name}! Added to inventory.`);
                    } else {
                        gameState.pet.hasEgg = true;
                        gameState.pet.eggType = itemKey;
                        gameState.pet.hatchTime = Date.now();
                        showNotification(`✅ Bought ${itemData.name}! It will hatch soon!`);
                    }
                    break;
            }
            
            updateDisplay();
            saveGame();
            
            // Refresh the shop display
            openShopPopup(shopType);
        }

        function openProgressPopup() {
            const popup = document.getElementById('progressPopup');
            popup.classList.add('active');
            switchTab('achievements'); // Default to achievements tab
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Update content based on tab
            switch (tabName) {
                case 'achievements':
                    updateAchievements();
                    break;
                case 'missions':
                    updateMissions();
                    break;
                case 'login':
                    updateDailyLogin();
                    break;
                case 'leaderboard':
                    if (isOnline) updateLeaderboard();
                    break;
                case 'status':
                    updatePlayerStatus();
                    break;
            }
        }

        function updateAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';

            gameState.achievements.forEach(achievement => {
                // Update current progress
                switch (achievement.id) {
                    case 1:
                        achievement.current = gameState.stats.totalPlanted;
                        break;
                    case 2:
                        achievement.current = gameState.stats.totalHarvested;
                        break;
                    case 3:
                        achievement.current = gameState.stats.rareMutations;
                        break;
                    case 4:
                        achievement.current = gameState.stats.totalEarned;
                        break;
                    case 5:
                        achievement.current = gameState.level;
                        break;
                }

                if (achievement.current >= achievement.target && !achievement.completed) {
                    achievement.completed = true;
                    showNotification(`🏆 Achievement unlocked: ${achievement.name}!`);
                }

                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement-item ${achievement.completed ? 'completed' : ''}`;
                achievementElement.innerHTML = `
                    <div><strong>${achievement.name}</strong></div>
                    <div>${achievement.description}</div>
                    <div>Progress: ${achievement.current}/${achievement.target}</div>
                    <div>Reward: ${achievement.reward} 💰</div>
                    ${achievement.completed && !achievement.claimed ? '<button class="btn" onclick="claimAchievement(' + achievement.id + ')">Claim Reward</button>' : ''}
                `;
                achievementsList.appendChild(achievementElement);
            });
        }

        function updateMissions() {
            const missionsList = document.getElementById('missionsList');
            missionsList.innerHTML = '';

            gameState.missions.forEach(mission => {
                // Update current progress based on today's stats
                switch (mission.type) {
                    case 'plant':
                        // You'd need to track daily stats separately
                        mission.current = Math.min(mission.current + 1, mission.target);
                        break;
                    case 'harvest':
                        mission.current = Math.min(mission.current + 1, mission.target);
                        break;
                    case 'earn':
                        mission.current = Math.min(mission.current + 100, mission.target);
                        break;
                    case 'mutation':
                        mission.current = Math.min(mission.current + 1, mission.target);
                        break;
                }

                if (mission.current >= mission.target && !mission.completed) {
                    mission.completed = true;
                }

                const missionElement = document.createElement('div');
                missionElement.className = `mission-item ${mission.completed ? 'completed' : ''}`;
                missionElement.innerHTML = `
                    <div><strong>${mission.description}</strong></div>
                    <div>Progress: ${mission.current}/${mission.target}</div>
                    <div>Reward: ${mission.reward} 💰</div>
                    ${mission.completed && !mission.claimed ? '<button class="btn" onclick="claimMission(' + mission.id + ')">Claim Reward</button>' : ''}
                `;
                missionsList.appendChild(missionElement);
            });
        }

        function updateDailyLogin() {
            const loginCalendar = document.getElementById('loginCalendar');
            loginCalendar.innerHTML = '';

            gameState.dailyLogin.rewards.forEach((reward, index) => {
                const day = index + 1;
                const dayElement = document.createElement('div');
                dayElement.className = 'login-day';
                
                if (reward.claimed) {
                    dayElement.classList.add('completed');
                } else if (day === gameState.dailyLogin.streak) {
                    dayElement.classList.add('current');
                }
                
                let rewardText = '';
                switch (reward.reward.type) {
                    case 'heckless':
                        rewardText = `${reward.reward.amount}💰`;
                        break;
                    case 'seeds':
                        rewardText = '🌱 Seeds';
                        break;
                    case 'gear':
                        rewardText = '⚒️ Gear';
                        break;
                }
                
                const canClaim = day === gameState.dailyLogin.streak && !reward.claimed && !gameState.dailyLogin.claimedToday;
                
                dayElement.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Day ${day}</div>
                    <div style="font-size: 12px; margin-bottom: 8px;">${rewardText}</div>
                    ${canClaim ? 
                        '<button class="btn" onclick="claimDailyReward(' + day + ')">Claim</button>' : 
                        (reward.claimed ? '<div style="color: #4CAF50;">✓ Claimed</div>' : '<div style="color: #ccc;">Locked</div>')
                    }
                `;
                
                loginCalendar.appendChild(dayElement);
            });
        }

        function useTool(toolKey) {
            const tool = gameData.gear[toolKey];
            const count = gameState.inventory.tools[toolKey];
            
            if (count <= 0) {
                showNotification('❌ No tools available!');
                return;
            }
            
            if (tool.type === 'sprinkler') {
                const emptyPlot = gameState.plots.find(plot => !plot.sprinkler);
                if (emptyPlot) {
                    emptyPlot.sprinkler = new Sprinkler(toolKey, emptyPlot.id);
                    gameState.inventory.tools[toolKey]--;
                    if (gameState.inventory.tools[toolKey] <= 0) {
                        delete gameState.inventory.tools[toolKey];
                    }
                    showNotification(`✅ Placed ${tool.name}!`);
                    updateInventoryDisplay('tools');
                    saveGame();
                } else {
                    showNotification('❌ No empty plots for sprinkler!');
                }
            } else if (tool.type === 'consumable') {
                applyConsumableEffect(tool);
                gameState.inventory.tools[toolKey]--;
                if (gameState.inventory.tools[toolKey] <= 0) {
                    delete gameState.inventory.tools[toolKey];
                }
                showNotification(`✅ Used ${tool.name}! Effect active for ${formatTime(tool.duration)}`);
                updateInventoryDisplay('tools');
                saveGame();
            }
        }

        function useEgg(eggKey) {
            const egg = gameData.petEggs[eggKey];
            const count = gameState.inventory.eggs[eggKey];
            
            if (count <= 0) {
                showNotification('❌ No eggs available!');
                return;
            }
            
            if (gameState.pet.hasEgg || gameState.pet.type) {
                showNotification('❌ You already have a pet or egg hatching!');
                return;
            }
            
            gameState.pet.hasEgg = true;
            gameState.pet.eggType = eggKey;
            gameState.pet.hatchTime = Date.now();
            
            gameState.inventory.eggs[eggKey]--;
            if (gameState.inventory.eggs[eggKey] <= 0) {
                delete gameState.inventory.eggs[eggKey];
            }
            
            showNotification(`🥚 Started hatching ${egg.name}! It will hatch in ${formatTime(egg.hatchTime)}`);
            updateInventoryDisplay('eggs');
            saveGame();
        }

        async function updateLeaderboard() {
            if (!db || !isOnline) {
                document.getElementById('leaderboardList').innerHTML = '<div style="text-align: center; color: #666;">Available in online mode only</div>';
                return;
            }

            try {
                const { collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const leaderboardRef = collection(db, 'leaderboard');
                const q = query(leaderboardRef, orderBy('totalEarned', 'desc'), limit(10));
                const querySnapshot = await getDocs(q);
                
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div>
                            <span class="leaderboard-rank">#${rank}</span>
                            <span>${data.email}</span>
                        </div>
                        <div>
                            <span>Lv.${data.level} | ${data.totalEarned}💰 | ${data.rareMutations}✨</span>
                        </div>
                    `;
                    leaderboardList.appendChild(item);
                    rank++;
                });
                
                if (rank === 1) {
                    leaderboardList.innerHTML = '<div style="text-align: center; color: #666;">No players yet</div>';
                }
            } catch (error) {
                console.log('Failed to load leaderboard:', error);
                document.getElementById('leaderboardList').innerHTML = '<div style="text-align: center; color: #666;">Failed to load leaderboard</div>';
            }
        }

        function updatePlayerStatus() {
            const statusGrid = document.getElementById('statusGrid');
            statusGrid.innerHTML = `
                <div class="status-card">
                    <div class="status-value">${gameState.level}</div>
                    <div class="status-label">Level</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.xp}</div>
                    <div class="status-label">Experience</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.heckless}</div>
                    <div class="status-label">Heckless</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.stats.totalPlanted}</div>
                    <div class="status-label">Seeds Planted</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.stats.totalHarvested}</div>
                    <div class="status-label">Fruits Harvested</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.stats.totalEarned}</div>
                    <div class="status-label">Total Earned</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.stats.rareMutations}</div>
                    <div class="status-label">Rare Mutations</div>
                </div>
                <div class="status-card">
                    <div class="status-value">${gameState.dailyLogin.streak}</div>
                    <div class="status-label">Login Streak</div>
                </div>
            `;
        }

        function closePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
        }

        function claimAchievement(achievementId) {
            const achievement = gameState.achievements.find(a => a.id === achievementId);
            if (achievement && achievement.completed && !achievement.claimed) {
                gameState.heckless += achievement.reward;
                gameState.xp += Math.floor(achievement.reward / 2);
                achievement.claimed = true;
                checkLevelUp();
                showNotification(`🏆 Achievement claimed! Earned ${achievement.reward} Heckless!`);
                updateDisplay();
                updateAchievements();
                saveGame();
            }
        }

        function claimMission(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (mission && mission.completed && !mission.claimed) {
                gameState.heckless += mission.reward;
                gameState.xp += Math.floor(mission.reward / 4);
                mission.claimed = true;
                checkLevelUp();
                showNotification(`🎯 Mission completed! Earned ${mission.reward} Heckless!`);
                updateDisplay();
                updateMissions();
                saveGame();
            }
        }

        // Make functions global for onclick handlers
        window.openAuthPopup = openAuthPopup;
        window.openShopPopup = openShopPopup;
        window.openProgressPopup = openProgressPopup;
        window.closePopup = closePopup;
        window.switchTab = switchTab;
        window.logout = logout;
        window.clearSelection = clearSelection;
        window.claimDailyReward = claimDailyReward;
        window.claimAchievement = claimAchievement;
        window.claimMission = claimMission;

        // Game Loop
        function gameLoop() {
            updateWeather();
            updateDisplay();
            saveGame();
        }

        // Initialize Game
        function initGame() {
            loadGame();
            updateDisplay();
            
            // Start game loop
            setInterval(gameLoop, 3000);
            
            // Initialize Firebase
            initFirebase();
            
            showNotification('🌾 Welcome to Garden Empire!');
        }

        // Start the game
        initGame();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9753445545c689b0',t:'MTc1NjIxMDY1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
